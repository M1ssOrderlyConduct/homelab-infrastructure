#!/usr/bin/env python3
"""EthShare - Toggle WiFi-to-Ethernet sharing from the KDE system tray."""

import fcntl
import os
import signal
import subprocess
import sys
import threading

from PyQt5.QtCore import QTimer
from PyQt5.QtGui import QIcon
from PyQt5.QtWidgets import QApplication, QMenu, QSystemTrayIcon

HELPER = "/usr/local/share/ethshare/helper.sh"
STATE_FILE = "/tmp/ethshare.active"
LOCK_FILE = "/tmp/ethshare.lock"

ICON_ON = "network-transmit-receive"
ICON_OFF = "network-offline"


class EthShare:
    def __init__(self, app):
        self.app = app
        self.sharing = False
        self.busy = False

        self.tray = QSystemTrayIcon(QIcon.fromTheme(ICON_OFF), parent=app)
        self.tray.setToolTip("EthShare")

        self._check_state()
        self._rebuild_menu()
        self.tray.show()

        self.timer = QTimer()
        self.timer.timeout.connect(self._poll_state)
        self.timer.start(10_000)

    # -- menu --

    def _rebuild_menu(self):
        menu = QMenu()

        if self.busy:
            toggle_label = "Applying..."
        elif self.sharing:
            toggle_label = "Disable Sharing"
        else:
            toggle_label = "Enable Sharing"

        toggle_action = menu.addAction(toggle_label)
        toggle_action.setEnabled(not self.busy)
        toggle_action.triggered.connect(self._on_toggle)

        menu.addSeparator()

        status_label = "Sharing: WiFi \u2192 Ethernet" if self.sharing else "Sharing: Off"
        status_action = menu.addAction(status_label)
        status_action.setEnabled(False)

        ssid = self._get_wifi_ssid()
        wifi_action = menu.addAction(f"WiFi: {ssid}")
        wifi_action.setEnabled(False)

        menu.addSeparator()

        quit_action = menu.addAction("Quit")
        quit_action.triggered.connect(self.app.quit)

        self.tray.setContextMenu(menu)

        icon_name = ICON_ON if self.sharing else ICON_OFF
        self.tray.setIcon(QIcon.fromTheme(icon_name))
        tooltip = "EthShare: Sharing Active" if self.sharing else "EthShare: Off"
        self.tray.setToolTip(tooltip)

    # -- state --

    def _check_state(self):
        try:
            with open("/proc/sys/net/ipv4/ip_forward") as f:
                forwarding = f.read().strip() == "1"
            self.sharing = forwarding and os.path.exists(STATE_FILE)
        except OSError:
            self.sharing = False

    def _poll_state(self):
        old = self.sharing
        self._check_state()
        if old != self.sharing:
            self._rebuild_menu()

    def _get_wifi_ssid(self):
        try:
            result = subprocess.run(
                ["nmcli", "-t", "-f", "active,ssid", "dev", "wifi"],
                capture_output=True, text=True, timeout=5,
            )
            for line in result.stdout.strip().splitlines():
                if line.startswith("yes:"):
                    return line.split(":", 1)[1]
        except (subprocess.SubprocessError, OSError):
            pass
        return "\u2014"

    # -- toggle (async) --

    def _on_toggle(self):
        if self.busy:
            return
        action = "disable" if self.sharing else "enable"
        self.busy = True
        self._rebuild_menu()

        thread = threading.Thread(target=self._run_helper, args=(action,), daemon=True)
        thread.start()

    def _run_helper(self, action):
        try:
            result = subprocess.run(
                ["sudo", HELPER, action],
                capture_output=True, text=True, timeout=30,
            )
            success = result.returncode == 0
        except subprocess.SubprocessError:
            success = False

        QTimer.singleShot(0, lambda: self._on_helper_done(success))

    def _on_helper_done(self, success):
        self.busy = False
        if success:
            self._check_state()
        self._rebuild_menu()


def main():
    # Single-instance guard
    lock_fd = open(LOCK_FILE, "w")
    try:
        fcntl.flock(lock_fd, fcntl.LOCK_EX | fcntl.LOCK_NB)
    except OSError:
        sys.exit(0)
    lock_fd.write(str(os.getpid()))
    lock_fd.flush()

    signal.signal(signal.SIGINT, signal.SIG_DFL)

    app = QApplication(sys.argv)
    app.setQuitOnLastWindowClosed(False)
    app.setApplicationName("EthShare")
    app.setDesktopFileName("ethshare")

    EthShare(app)
    sys.exit(app.exec_())


if __name__ == "__main__":
    main()
